cd /Users/ted.hsu/Desktop/Projects/allianz-onesub-www

# Check if jq is installed
if ! command -v jq &> /dev/null; then
    echo "jq is not installed. Installing jq..."
    brew install jq
fi

# Remove File if it already exists
html_file="./cve_report.html"

if [ -f "$html_file" ] ; then
    rm "$html_file"
fi

# Define the API URL
API_URL="https://services.nvd.nist.gov/rest/json/cves/2.0"
# API key
API_KEY="4e5e4372-7e5b-4a89-a28b-4e046ef9db3b"

# Get dependencies from package-lock.json
dependencies=$(jq -r '.dependencies' package-lock.json)

# Maximum retry attempts
MAX_RETRIES=100

# Total number of entries to process
TOTAL_ENTRIES=$(jq -r '.dependencies | length' package-lock.json)
CURRENT_INDEX=0

# Initialize HTML content
echo "<html>
<head>
<title>CVE Risk Report</title>
<style>
    body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    th {
        background-color: #f2f2f2;
    }
</style>
</head>
<body>" >> "$html_file"

# Run jq command to extract keys and versions from package-lock.json
jq -r '.dependencies | to_entries[] | "\(.key) \(.value.version)"' package-lock.json | while read -r line; do
    # Increment current index
    CURRENT_INDEX=$((CURRENT_INDEX + 1))
    
    # Specify the keyword search parameter
    KEYWORD=$(echo "$line" | awk '{print $1}')
    VERSION=$(echo "$line" | awk '{print $2}')
    # For testing
    # KEYWORD="crypto-js"
    # VERSION="4.0.0"
    # KEYWORD="xml2js"
    # VERSION="0.4.23"

    echo "Fetching data from NVD NIST API (${CURRENT_INDEX}/${TOTAL_ENTRIES}): ${KEYWORD} ${VERSION}..."

    retry=0
    while [ ${retry} -lt ${MAX_RETRIES} ]; do
        # Construct the full API request URL
        REQUEST_URL="${API_URL}?virtualMatchString=cpe:2.3:*:*:${KEYWORD}:${VERSION}:*:*:*"

        # Send a GET request using curl with progress information and API key in header,
        # and save the response to a temporary file
        temp_file=$(mktemp)
        http_code=$(curl -s -o "$temp_file" -w "%{http_code}" -# --header "apiKey: ${API_KEY}" "$REQUEST_URL")

        if [ "$http_code" -eq 503 ]; then
            echo "Received HTTP 503 error. Retrying (attempt ${retry}/${MAX_RETRIES})..."
            rm "$temp_file"
            retry=$((retry + 1))
            sleep 6
        else
            break  # Exit the retry loop if request was successful
        fi
    done

    # Check if maximum retries exceeded
    if [ ${retry} -eq ${MAX_RETRIES} ]; then
        echo "Maximum retry attempts (${MAX_RETRIES}) reached. Exiting..."
        exit 1
    fi

    # Extract totalResults from JSON
    total_results=$(jq -r '.totalResults' "$temp_file")
    package_name=$KEYWORD
    package_version=$VERSION
    cve_format=$(jq -r '.format' "$temp_file")
    cve_version=$(jq -r '.version' "$temp_file")
    query_date=$(jq -r '.timestamp' "$temp_file")

    # Start building HTML table for the CVE data
    echo "<h2>Vulnerability Report for ${KEYWORD} ${VERSION}</h2>
    <table>
    <tr><th>Package Name</th><td colspan='7'>${package_name}</td></tr>
    <tr><th>Package Version</th><td colspan='7'>${package_version}</td></tr>
    <tr><th>CVE Format</th><td colspan='7'>${cve_format}</td></tr>
    <tr><th>CVE Version</th><td colspan='7'>${cve_version}</td></tr>
    <tr><th>Query Date</th><td colspan='7'>${query_date}</td></tr>
    <tr><th>CVE ID</th><th>Published Date</th><th>Last Modified Date</th><th>CVSS Base Score</th><th>CVSS Base Severity</th><th>Description</th><th>Handling Instructions</th></tr>" >> "$html_file"

    # Check if totalResults is 0, skip processing if true
    if [ -z "$total_results" ] || [ "$total_results" -eq 0 ]; then
        echo "<tr><td colspan='7'>No vulnerabilities found for '${KEYWORD}'.</td></tr>" >> "$html_file"
    else
        # Loop through each vulnerability and append to HTML table
        jq -r '.vulnerabilities[] | 
            "<tr><td>\(.cve.id)</td><td>\(.cve.published)</td><td>\(.cve.lastModified)</td><td>\(.cve.metrics.cvssMetricV31[0].cvssData.baseScore)</td><td>\(.cve.metrics.cvssMetricV31[0].cvssData.baseSeverity)</td><td>\(.cve.descriptions[0].value)</td><td></td></tr>"' "$temp_file" >> "$html_file"
    fi

    # End HTML table for current CVE data
    echo "</table><br>" >> "$html_file"
    rm "$temp_file"
    sleep 6
done

# Close HTML body and document
echo "</body></html>" >> "$html_file"

echo "HTML report saved: $html_file"
